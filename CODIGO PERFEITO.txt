import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import api from "@/services/api";
import { FileText, Sparkles, LogOut, Layers3, BookOpenText, Utensils, Rocket } from "lucide-react";
import { LineChart, Line, CartesianGrid, XAxis, YAxis, Tooltip, ResponsiveContainer, Legend } from "recharts";
import Logo from "@/assets/logo-adsfood.svg";

interface Campaign {
  id: number;
  titulo: string;
  status: string;
  orcamento: number;
  clicks?: number;
  impressao?: number;
  cpc?: number;
  cpm?: number;
  roi?: number;
  produto?: string;
  dataCriacao?: string;
}

export default function Dashboard() {
  const navigate = useNavigate();
  const [nomeRestaurante, setNomeRestaurante] = useState("");
  const [metaConnected, setMetaConnected] = useState(false);
  const [campanhas, setCampanhas] = useState<Campaign[]>([]);

  useEffect(() => {
    const token = localStorage.getItem("token");
    const nome = localStorage.getItem("nomeRestaurante");
    const meta = localStorage.getItem("facebookToken");

    if (!token) {
      navigate("/login");
    }

    if (nome) setNomeRestaurante(nome);
    if (meta) setMetaConnected(true);

    fetchCampanhas();
  }, [navigate]);

  async function fetchCampanhas() {
    try {
      const response = await api.get("/campaigns");
      setCampanhas(response.data);
    } catch (error) {
      console.error("Erro ao buscar campanhas:", error);
    }
  }

  const campanhasAtivas = campanhas.filter(c => c.status === "Ativa").length;
  const campanhasPausadas = campanhas.filter(c => c.status === "Pausada").length;
  const campanhasFinalizadas = campanhas.filter(c => c.status === "Finalizada").length;
  const orcamentoTotal = campanhas.reduce((total, campanha) => campanha.status === "Ativa" ? total + campanha.orcamento : total, 0);
  const ultimaCampanha = campanhas.length > 0 ? campanhas[campanhas.length - 1] : null;
  const campanhaTopROI = campanhas.reduce((top, curr) => (curr.roi && (!top || curr.roi > (top.roi || 0))) ? curr : top, null);

  const produtoMaisPromovido = campanhas.reduce((acc, c) => {
    if (!c.produto) return acc;
    acc[c.produto] = (acc[c.produto] || 0) + 1;
    return acc;
  }, {} as Record<string, number>);

  const dadosGraficoClicks = campanhas.map((c) => ({
    name: c.titulo,
    clicks: c.clicks || 0,
    impressao: c.impressao || 0
  }));

  const topProdutos = Object.entries(produtoMaisPromovido)
    .map(([produto, qtd]) => ({ produto, qtd }))
    .sort((a, b) => b.qtd - a.qtd);

  function handleLogout() {
    localStorage.clear();
    navigate("/login");
  }

  const menuItems = [
    { icon: <Sparkles className="w-6 h-6" />, label: "In√≠cio", route: "/dashboard" },
    { icon: <Sparkles className="w-6 h-6" />, label: "Adicionar Legenda", route: "/generate-legend" },
    { icon: <BookOpenText className="w-6 h-6" />, label: "Hist√≥rico de Legendas", route: "/legendas" },
    { icon: <Layers3 className="w-6 h-6" />, label: "Campanhas", route: "/campaigns" },
    { icon: <FileText className="w-6 h-6" />, label: "Nova Campanha", route: "/new-campaign" },
    { icon: <Rocket className="w-6 h-6" />, label: "Campanha Autom√°tica", route: "/automacao/visualizar" },
    { icon: <Utensils className="w-6 h-6" />, label: "Card√°pio", route: "/importar-link" },
    { icon: <LogOut className="w-6 h-6" />, label: "Sair", route: "/logout", action: handleLogout }
  ];

  return (
    <div className="flex min-h-screen">
      {/* Menu lateral expans√≠vel ao hover */}
      <aside className="bg-purple-700 text-white flex flex-col py-6 px-2 transition-all duration-300 group hover:w-48 w-20 overflow-hidden">
        <div
          className="flex items-center gap-2 justify-center group-hover:justify-start px-2 mb-6 cursor-pointer"
          onClick={() => navigate("/dashboard")}
        >
          <img src={Logo} alt="ADSFOOD Logo" className="w-8 h-8 object-contain rounded-full" />
          <span className="hidden group-hover:inline text-sm font-bold">ADSFOOD</span>
        </div>

        {menuItems.map(({ icon, label, route, action }, index) => (
          <div
            key={index}
            className="flex items-center gap-3 px-2 py-2 hover:bg-purple-600 rounded-xl cursor-pointer"
            onClick={() => action ? action() : navigate(route)}
          >
            {icon}
            <span className="hidden group-hover:inline text-sm">{label}</span>
          </div>
        ))}
      </aside>

      {/* Conte√∫do principal */}
      <div className="flex-1 bg-gradient-to-br from-purple-300 via-white to-purple-300 p-6">
        <div className="bg-white rounded-3xl shadow-2xl p-8 max-w-6xl mx-auto text-center animate-fadeIn">
          <h1 className="text-4xl font-bold text-purple-700 mb-4">Dashboard üçî</h1>

          <p className="text-lg text-gray-700 mb-4">
            Bem-vindo, <span className="font-bold">{nomeRestaurante || "Restaurante"}</span>!
          </p>

          {metaConnected && (
            <div className="text-green-600 font-bold mb-4">‚úÖ Conta Meta Ads conectada!</div>
          )}

          <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div className="bg-green-100 p-4 rounded-xl shadow">
              <h2 className="text-xl font-bold text-green-700">{campanhasAtivas}</h2>
              <p className="text-green-700">Campanhas Ativas</p>
            </div>
            <div className="bg-yellow-100 p-4 rounded-xl shadow">
              <h2 className="text-xl font-bold text-yellow-700">{campanhasPausadas}</h2>
              <p className="text-yellow-700">Campanhas Pausadas</p>
            </div>
            <div className="bg-red-100 p-4 rounded-xl shadow">
              <h2 className="text-xl font-bold text-red-700">{campanhasFinalizadas}</h2>
              <p className="text-red-700">Campanhas Finalizadas</p>
            </div>
            <div className="bg-blue-100 p-4 rounded-xl shadow">
              <h2 className="text-xl font-bold text-blue-700">R$ {orcamentoTotal.toFixed(2)}</h2>
              <p className="text-blue-700">Or√ßamento Investido</p>
            </div>
          </div>

          <div className="mb-8">
            <h2 className="text-xl font-bold text-purple-600 mb-2">üìä Gr√°fico de Cliques e Impress√µes</h2>
            <ResponsiveContainer width="100%" height={300}>
              <LineChart data={dadosGraficoClicks}>
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" />
                <YAxis />
                <Tooltip />
                <Legend />
                <Line type="monotone" dataKey="clicks" stroke="#4F46E5" name="Cliques" />
                <Line type="monotone" dataKey="impressao" stroke="#22C55E" name="Impress√µes" />
              </LineChart>
            </ResponsiveContainer>
          </div>

          {topProdutos.length > 0 && (
            <div className="mb-8">
              <h2 className="text-xl font-bold text-purple-600 mb-2">üî• Tend√™ncia do M√™s</h2>
              <p className="text-gray-700">Produto mais promovido: <span className="font-bold text-purple-700">{topProdutos[0].produto}</span></p>
            </div>
          )}

          {campanhaTopROI && (
            <div className="mb-8">
              <h2 className="text-xl font-bold text-purple-600 mb-2">üèÜ Melhor Campanha (ROI)</h2>
              <p className="text-gray-700">{campanhaTopROI.titulo} - ROI: <span className="font-bold text-green-600">{campanhaTopROI.roi}%</span></p>
            </div>
          )}

          {ultimaCampanha && (
            <div className="mb-8">
              <h2 className="text-xl font-bold text-purple-600 mb-2">üïì √öltima Campanha Criada</h2>
              <p className="text-gray-700">{ultimaCampanha.titulo} - Status: <span className={`font-bold ${ultimaCampanha.status === "Ativa" ? "text-green-600" : ultimaCampanha.status === "Pausada" ? "text-yellow-600" : "text-red-600"}`}>{ultimaCampanha.status}</span></p>
            </div>
          )}

          <div className="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-xl">
            <p>üí° Dica: Crie campanhas para produtos com maior engajamento. Use as legendas geradas com IA para melhorar convers√£o!</p>
          </div>
        </div>
      </div>
    </div>
  );
}




